<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<body>
<div th:fragment="content">

    <style>
        /* 테이블 레이아웃 최적화 */
        .product-table {
            width: 100%;
            /* 모바일에서 겹침 방지를 위해 고정 레이아웃 해제 */
            table-layout: auto !important;
        }

        .product-table th, .product-table td {
            padding: 0.5rem;
            vertical-align: middle;
        }

        /* 상품명: 모바일에서 너비 확보 및 말줄임 처리 */
        .product-table .td-name {
            min-width: 150px;
            max-width: 0; /* flex 효과처럼 작동하여 남은 공간 차지 */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 상태 배지 고정 폭 */
        .product-table .status-badge {
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        /* 관리 버튼 영역 */
        .product-table .td-actions {
            white-space: nowrap;
        }

        /* 모바일 대응 미디어 쿼리 */
        @media (max-width: 768px) {
            .product-table {
                font-size: 0.8rem; /* 글자 크기 축소 */
            }

            /* 모바일에서 불필요한 열 숨기기 */
            .hide-on-mobile {
                display: none !important;
            }

            /* 썸네일 크기 축소 */
            .img-thumbnail {
                width: 40px !important;
                height: 40px !important;
            }

            /* 관리 버튼 세로 정렬 또는 간격 축소 */
            .td-actions .gap-1 {
                gap: 2px !important;
            }

            .btn-sm {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
        }
    </style>

    <!-- 상태 탭 -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link" th:classappend="${status == null or status == ''} ? ' active' : ''"
                    th:href="@{/admin/products(page=0,q=${q},categoryId=${categoryId},sort=${sort},status='')}">
                전체 <span class="badge text-bg-light border ms-1" th:text="${totalCount}">0</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:classappend="${status == 'ACTIVE'} ? ' active' : ''"
                    th:href="@{/admin/products(page=0,q=${q},categoryId=${categoryId},sort=${sort},status='ACTIVE')}">
                판매중 <span class="badge text-bg-light border ms-1" th:text="${activeCount}">0</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:classappend="${status == 'HIDDEN'} ? ' active' : ''"
                    th:href="@{/admin/products(page=0,q=${q},categoryId=${categoryId},sort=${sort},status='HIDDEN')}">
                판매중지 <span class="badge text-bg-light border ms-1" th:text="${hiddenCount}">0</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:classappend="${status == 'SOLD_OUT'} ? ' active' : ''"
                    th:href="@{/admin/products(page=0,q=${q},categoryId=${categoryId},sort=${sort},status='SOLD_OUT')}">
                품절 <span class="badge text-bg-light border ms-1" th:text="${soldOutCount}">0</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:classappend="${status == 'DELETED'} ? ' active' : ''"
                    th:href="@{/admin/products(page=0,q=${q},categoryId=${categoryId},sort=${sort},status='DELETED')}">
                삭제 <span class="badge text-bg-light border ms-1" th:text="${deletedCount}">0</span>
            </a>
        </li>
    </ul>

    <!-- 검색 -->
    <form method="get" action="/admin/products" class="row g-2 align-items-end">
        <input type="hidden" name="status" th:value="${status}"> <input type="hidden" name="page" value="0">

        <div class="col-12 col-md-4">
            <label class="form-label">키워드</label> <input class="form-control" name="q" placeholder="상품명 또는 상품번호(ID)"
                th:value="${q}">
        </div>

        <div class="col-12 col-md-3">
            <label class="form-label">카테고리</label> <select class="form-select" name="categoryId">
            <option value="" th:selected="${categoryId == null}">전체</option>
            <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"
                    th:selected="${categoryId != null and c.id == categoryId}"></option>
        </select>
        </div>

        <div class="col-12 col-md-3">
            <label class="form-label">정렬</label> <select class="form-select" name="sort">
            <option value="CREATED_DESC" th:selected="${sort == 'CREATED_DESC'}">최신순</option>
            <option value="PRICE_ASC" th:selected="${sort == 'PRICE_ASC'}">가격↑</option>
            <option value="PRICE_DESC" th:selected="${sort == 'PRICE_DESC'}">가격↓</option>
        </select>
        </div>

        <div class="col-12 col-md-1 d-grid">
            <button class="btn btn-primary" type="submit">검색</button>
        </div>

        <div class="col-12 col-md-1 d-grid">
            <a class="btn btn-outline-secondary" th:href="@{/admin/products}">초기화</a>
        </div>
    </form>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted small" th:text="'총 ' + ${result.totalElements} + '건'">총 0건</div>
        <a class="btn btn-success btn-sm" href="/admin/products/new">상품 등록</a>
    </div>

    <hr class="my-3"/>

    <div class="table-responsive">
        <table class="table table-sm table-striped align-middle product-table">
            <colgroup class="d-none d-md-table-column-group">
                <col style="width:70px;">   <col style="width:80px;">   <col>                       <col style="width:120px;">  <col style="width:100px;">  <col style="width:70px;">   <col style="width:100px;">  <col style="width:200px;">  </colgroup>

            <thead>
            <tr>
                <th>썸네일</th>
                <th class="hide-on-mobile">상품번호</th> <th>상품명</th>
                <th>카테고리</th>
                <th class="text-end hide-on-mobile">가격</th> <th class="text-end hide-on-mobile">재고</th> <th class="text-center">상태</th>
                <th class="text-end">관리</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="p : ${result.content}" th:if="${p != null}"
                    th:classappend="${p.status == 'DELETED'} ? ' text-muted' : ''">

                <td>
                    <a th:if="${p.status != 'DELETED'}" th:href="@{|/admin/products/${p.id}/edit|}">
                        <img class="img-thumbnail" loading="lazy" style="width:48px;height:48px;object-fit:cover;"
                                th:src="${#strings.isEmpty(p.thumbnailUrl) ? '/img/no-image.svg' : p.thumbnailUrl}"
                                alt="thumb">
                    </a>
                    <img th:if="${p.status == 'DELETED'}" class="img-thumbnail" loading="lazy"
                            style="width:48px;height:48px;object-fit:cover;"
                            th:src="${#strings.isEmpty(p.thumbnailUrl) ? '/img/no-image.svg' : p.thumbnailUrl}"
                            alt="thumb">
                </td>

                <td class="hide-on-mobile" th:text="${p.id}">1</td>

                <td class="td-name">
                    <a th:href="@{|/admin/products/${p.id}/edit|}" th:text="${p.name}" th:if="${p.status != 'DELETED'}"
                            th:title="${p.name}">상품명</a>
                    <span th:text="${p.name}" th:if="${p.status == 'DELETED'}" th:title="${p.name}">상품명</span>
                </td>

                <td class="td-category">
                    <span class="d-inline-block text-truncate" style="max-width: 80px;" th:text="${p.categoryName}" th:title="${p.categoryName}"></span>
                </td>

                <td class="text-end hide-on-mobile" th:text="${#numbers.formatInteger(p.price, 0, 'COMMA')}">10,000</td>

                <td class="text-end hide-on-mobile" th:text="${p.stock}">50</td>

                <td class="text-center">
                    <span class="badge status-badge" th:classappend="
                    ${p.status == 'ACTIVE'} ? ' text-bg-success' :
                    (${p.status == 'HIDDEN'} ? ' text-bg-warning' :
                    (${p.status == 'SOLD_OUT'} ? ' text-bg-info' :
                    ' text-bg-secondary'))
                  " th:text="${p.status}"> ACTIVE </span>
                </td>

                <td class="text-end td-actions">
                    <div th:if="${p.status != 'DELETED'}" class="d-inline-flex gap-1 align-items-center">
                        <a class="btn btn-outline-secondary btn-sm" th:href="@{|/admin/products/${p.id}/edit|}">수정</a>

                        <form th:if="${p.status == 'ACTIVE'}" method="post"
                                th:action="@{|/admin/products/${p.id}/hide|}" class="d-inline hide-on-mobile">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn btn-outline-warning btn-sm" type="submit">중지</button>
                        </form>
                    </div>
                    <span class="text-muted" th:if="${p.status == 'DELETED'}">-</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- pagination -->
    <nav aria-label="Page navigation" class="mt-3" th:if="${result.totalPages > 1}">
        <ul class="pagination pagination-sm justify-content-center mb-0">

            <li class="page-item" th:classappend="${result.first} ? ' disabled' : ''">
                <a class="page-link"
                        th:href="@{/admin/products(page=${result.number-1},q=${q},categoryId=${categoryId},status=${status},sort=${sort})}">
                    이전
                </a>
            </li>

            <li class="page-item" th:each="i : ${#numbers.sequence(0, result.totalPages-1)}"
                    th:classappend="${i == result.number} ? ' active' : ''">
                <a class="page-link" th:text="${i+1}"
                        th:href="@{/admin/products(page=${i},q=${q},categoryId=${categoryId},status=${status},sort=${sort})}">
                    1
                </a>
            </li>

            <li class="page-item" th:classappend="${result.last} ? ' disabled' : ''">
                <a class="page-link"
                        th:href="@{/admin/products(page=${result.number+1},q=${q},categoryId=${categoryId},status=${status},sort=${sort})}">
                    다음
                </a>
            </li>

        </ul>
    </nav>
</div>
</body>
</html>