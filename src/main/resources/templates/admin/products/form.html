<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<body>
<div th:fragment="content">

    <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>
    <div class="alert alert-danger" th:if="${param.error}" th:text="${param.error}"></div>

    <!-- 삭제용 폼 2개: 메인 폼 바깥(중첩 금지 해결) -->
    <form id="thumbRemoveForm" method="post" th:if="${mode=='EDIT' and !#strings.isEmpty(currentThumbUrl)}"
            th:action="@{|/admin/products/${productId}/thumbnail/remove|}"
            onsubmit="return confirm('썸네일 이미지를 삭제하고 기본 이미지로 변경합니다. 진행할까요?');">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>

    <form id="detailRemoveForm" method="post" th:if="${mode=='EDIT' and !#strings.isEmpty(currentDetailUrl)}"
            th:action="@{|/admin/products/${productId}/detail/remove|}"
            onsubmit="return confirm('상세 이미지를 삭제하고 기본 이미지로 변경합니다. 진행할까요?');">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>

    <!-- 메인 저장 폼 -->
    <form method="post" th:action="${mode=='EDIT'} ? @{|/admin/products/${productId}|} : @{/admin/products}"
            th:object="${form}" class="row g-3" enctype="multipart/form-data">

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="col-12 col-md-8">
            <label class="form-label">상품명</label> <input class="form-control" th:field="*{name}" placeholder="상품명"
                th:classappend="${#fields.hasErrors('name')} ? ' is-invalid' : ''">
            <div class="text-danger small mt-1" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
        </div>

        <div class="col-12 col-md-2">
            <label class="form-label">1차 카테고리</label> <select class="form-select" id="parentCategory"
                onchange="loadSubCategories(this.value)">
            <option value="">대분류 선택</option>
            <option th:each="c : ${parentCategories}" th:value="${c.id}" th:text="${c.name}"
                    th:selected="${selectedParentId == c.id}"></option>
        </select>
        </div>

        <div class="col-12 col-md-2">
            <label class="form-label">2차 카테고리</label> <select class="form-select" th:field="*{categoryId}"
                id="childCategory" required>
            <option value="">소분류 선택</option>
            <option th:each="c : ${childCategories}" th:value="${c.id}" th:text="${c.name}"
                    th:selected="${c.id == form.categoryId}"></option>
        </select>
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">가격(원)</label> <input class="form-control" th:field="*{price}" type="number"
                min="0" step="1">
            <div class="text-danger small mt-1" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">재고</label> <input class="form-control" th:field="*{stock}" type="number" min="0"
                step="1">
            <div class="form-text">재고가 0이면 자동으로 SOLD_OUT 처리됩니다.</div>
            <div class="text-danger small mt-1" th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}"></div>
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">상태</label> <select class="form-select" th:field="*{status}">
            <option value="ACTIVE">판매중</option>
            <option value="HIDDEN">판매중지</option>
            <option value="SOLD_OUT">품절(선택해도 재고&gt;0이면 판매중으로 처리)</option>
        </select>
            <div class="text-danger small mt-1" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></div>
        </div>

        <div class="col-12">
            <label class="form-label">상품 상세 설명 (에디터)</label> <textarea id="summernote" th:field="*{content}"></textarea>
            <div class="form-text">이미지를 드래그 앤 드롭하여 본문에 삽입할 수 있습니다.</div>
        </div>

        <!-- 썸네일 -->
        <div class="col-12 col-md-6">
            <label class="form-label">썸네일 이미지(선택)</label>

            <div class="mb-2" th:if="${mode=='EDIT'}">
                <img class="img-thumbnail" style="max-height:160px;"
                        th:src="${#strings.isEmpty(currentThumbUrl) ? '/img/no-image.svg' : currentThumbUrl}"
                        alt="thumbnail">

                <div class="d-flex align-items-center justify-content-between mt-2">
                    <div class="text-muted small"
                            th:text="${#strings.isEmpty(currentThumbOriginalName) ? '기본 이미지' : currentThumbOriginalName}">
                        기본 이미지
                    </div>

                    <!-- 삭제 버튼: 외부 폼으로 submit -->
                    <button class="btn btn-outline-danger btn-sm" type="submit"
                            th:if="${mode=='EDIT' and !#strings.isEmpty(currentThumbUrl)}" form="thumbRemoveForm">
                        삭제
                    </button>
                </div>
            </div>

            <input class="form-control mb-1" type="file" name="thumbnailFile" accept="image/*"> <input
                class="form-control" type="text" th:field="*{thumbnailDirectUrl}"
                placeholder="또는 외부 이미지 URL 직접 입력 (예: http://...)">
            <div class="form-text">jpg/jpeg/png/webp, 최대 5MB</div>
        </div>

        <!-- 상세 -->
        <div class="col-12 col-md-6">
            <label class="form-label">상세 이미지(선택)</label>

            <div class="mb-2" th:if="${mode=='EDIT'}">
                <img class="img-thumbnail" style="max-height:160px;"
                        th:src="${#strings.isEmpty(currentDetailUrl) ? '/img/no-image.svg' : currentDetailUrl}"
                        alt="detail">

                <div class="d-flex align-items-center justify-content-between mt-2">
                    <div class="text-muted small"
                            th:text="${#strings.isEmpty(currentDetailOriginalName) ? '기본 이미지' : currentDetailOriginalName}">
                        기본 이미지
                    </div>

                    <!-- 삭제 버튼: 외부 폼으로 submit -->
                    <button class="btn btn-outline-danger btn-sm" type="submit"
                            th:if="${mode=='EDIT' and !#strings.isEmpty(currentDetailUrl)}" form="detailRemoveForm">
                        삭제
                    </button>
                </div>
            </div>

            <input class="form-control mb-1" type="file" name="detailImageFile" accept="image/*"> <input
                class="form-control" type="text" th:field="*{detailImageDirectUrl}"
                placeholder="또는 외부 상세 이미지 URL 직접 입력">
            <div class="form-text">jpg/jpeg/png/webp, 최대 5MB</div>
        </div>

        <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit" th:text="${mode == 'EDIT'} ? '수정 저장' : '등록 저장'">등록 저장</button>
            <a class="btn btn-outline-secondary" href="/admin/products">취소</a>
        </div>
    </form>
</div>
</body>
</html>
<script th:inline="javascript">
    $(document).ready(function () {
        const csrfToken = [[${_csrf.token}]];
        const csrfHeader = [[${_csrf.headerName}]];

        $('#summernote').summernote({
            height: 400,
            lang: 'ko-KR',
            placeholder: '상품 상세 내용을 입력하세요.',
            callbacks: {
                onImageUpload: function (files) {
                    for (let i = 0; i < files.length; i++) {
                        uploadImage(files[i], this, csrfToken, csrfHeader);
                    }
                },
            }
        });
    });

    function uploadImage(file, el, token, header) {
        let formData = new FormData();
        formData.append('file', file);

        $.ajax({
            data: formData,
            type: "POST",
            url: "/admin/api/image/upload",
            cache: false,
            contentType: false,
            processData: false,
            beforeSend: function (xhr) {
                xhr.setRequestHeader(header, token); // CSRF 헤더 추가
            },
            success: function (url) {
                $(el).summernote('insertImage', url);
            },
            error: function () {
                alert("이미지 업로드 실패");
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const parentSelect = document.getElementById('parentCategory');
        const childSelect = document.getElementById('childCategory');

        // 만약 1차는 선택되어 있는데 2차가 비어있다면 (서버에서 안 보냈을 경우 대비)
        if (parentSelect.value && childSelect.options.length <= 1) {
            const currentChildId = [[${form.categoryId}]]; // 현재 상품의 카테고리 ID
            loadSubCategories(parentSelect.value, currentChildId);
        }
    });

    // 기존 loadSubCategories 함수에 selectedId 파라미터 추가
    function loadSubCategories(parentId, selectedId = null) {
        const childSelect = document.getElementById('childCategory');
        childSelect.innerHTML = '<option value="">소분류 선택</option>';

        if (!parentId) return;

        fetch(`/admin/api/categories/${parentId}/children`)
            .then(res => {
                if (!res.ok) {
                    // 403 에러 등이 발생하면 여기서 가로챕니다.
                    throw new Error('API 호출 권한이 없거나 에러가 발생했습니다.');
                }
                return res.json();
            })
            .then(data => {
                // data가 배열인지 확인 후 실행
                if (Array.isArray(data)) {
                    data.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        if (selectedId && c.id == selectedId) {
                            option.selected = true;
                        }
                        childSelect.appendChild(option);
                    });
                }
            })
            .catch(err => console.error('Error:', err));
    }
</script>